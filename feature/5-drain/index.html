<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ivan Pepelnjak, ipSpace.net AG">
        <link rel="canonical" href="https://isis.bgplabs.net/feature/5-drain/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Drain Traffic Before Node Maintenance &#171; IS-IS Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">IS-IS Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Home</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Labs Overview</a>
</li>
                                    
<li>
    <a href="../../99-about/" class="dropdown-item">About the Project</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Installation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../1-setup/" class="dropdown-item">Installation and Setup</a>
</li>
                                    
<li>
    <a href="../../4-codespaces/" class="dropdown-item">Use GitHub Codespaces</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Basics</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../basic/" class="dropdown-item">Overview</a>
</li>
                                    
<li>
    <a href="../../basic/0-frrouting/" class="dropdown-item">Configuring IS-IS on FRRouting</a>
</li>
                                    
<li>
    <a href="../../basic/1-simple-ipv4/" class="dropdown-item">Configure IS-IS Routing for IPv4</a>
</li>
                                    
<li>
    <a href="../../basic/2-explore/" class="dropdown-item">Explore IS-IS Data Structures</a>
</li>
                                    
<li>
    <a href="../../basic/3-p2p/" class="dropdown-item">IS-IS on Point-to-Point Links</a>
</li>
                                    
<li>
    <a href="../../basic/4-metric/" class="dropdown-item">Using IS-IS Metrics</a>
</li>
                                    
<li>
    <a href="../../basic/5-ipv6/" class="dropdown-item">Dual-Stack (IPv4+IPv6) IS-IS Routing</a>
</li>
                                    
<li>
    <a href="../../basic/6-level-2/" class="dropdown-item">Optimize Simple IS-IS Deployments</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Features</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../1-passive/" class="dropdown-item">Passive IS-IS Interfaces</a>
</li>
                                    
<li>
    <a href="../2-dis/" class="dropdown-item">Influence the Designated IS Election</a>
</li>
                                    
<li>
    <a href="../3-md5/" class="dropdown-item">Protect IS-IS Routing Data with MD5 Authentication</a>
</li>
                                    
<li>
    <a href="../4-hide-transit/" class="dropdown-item">Hide Transit Subnets in IS-IS Networks</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Drain Traffic Before Node Maintenance</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Upcoming</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Overview</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../4-hide-transit/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../3-upcoming/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>

                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3">
<div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
  <div class="navbar-header">
      <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
          <span class="fa fa-angle-down"></span>
      </button>
  </div>

  
  
  
  
  
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary"  style="margin-bottom: 1em;">
      <ul class="nav flex-column">
          
      <li class="nav-item" data-level="1"><a href="#drain-traffic-before-node-maintenance" class="nav-link">Drain Traffic Before Node Maintenance</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="2"><a href="#device-requirements" class="nav-link">Device Requirements</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#starting-the-lab" class="nav-link">Starting the Lab</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#the-problem" class="nav-link">The Problem</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#draining-traffic-from-an-is-is-router" class="nav-link">Draining Traffic from an IS-IS Router</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#configuration-tasks" class="nav-link">Configuration Tasks</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#validation" class="nav-link">Validation</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#other-uses-of-the-overload-bit" class="nav-link">Other Uses of the Overload Bit</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#reference-information" class="nav-link">Reference Information</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#lab-wiring" class="nav-link">Lab Wiring</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#lab-addressing" class="nav-link">Lab Addressing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
        </ul>
      </li>
      </ul>
    </div>
  
  
  
  
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="drain-traffic-before-node-maintenance">Drain Traffic Before Node Maintenance</h1>
<p>Imagine you have a leaf-and-spine fabric with two spines. Each leaf has two equal-cost paths to every other leaf, resulting in a pretty optimal traffic distribution across all core links. </p>
<p><img alt="Lab topology" src="../topology-drain.png" /></p>
<p>Next, assume you must do some maintenance on S1. Turning it off would disrupt the traffic between L1 and L2 until they realize S1 is gone and the convergence process does its job (<a href="https://blog.ipspace.net/2020/11/fast-failover-implementation/">more details</a>).</p>
<p>Is there a way to drain the traffic from the spine switch before turning it off? You&rsquo;ll explore that in this lab exercise.</p>
<h2 id="device-requirements">Device Requirements</h2>
<ul>
<li>Use any device <a href="https://netlab.tools/platforms/#platform-routing-support">supported by the <em>netlab</em> IS-IS configuration module</a> for the routers in your lab (default: FRRouting virtual machines or containers).</li>
<li>You can do automated lab validation with FRRouting running on L1 and L2.</li>
</ul>
<h2 id="starting-the-lab">Starting the Lab</h2>
<p>You can start the lab <a href="../../1-setup/">on your own lab infrastructure</a> or in <a href="https://github.com/codespaces/new/bgplab/isis">GitHub Codespaces</a> (<a href="https://bgplabs.net/4-codespaces/">more details</a>):</p>
<ul>
<li>Change directory to <code>feature/5-drain</code></li>
<li>Execute <strong>netlab up</strong>. You&rsquo;ll get a lab with IPv4 addresses configured on all interfaces and level-2 IS-IS routing configured on all routers.</li>
<li>Log into lab routers with <strong>netlab connect</strong> and verify their configuration.</li>
</ul>
<h2 id="the-problem">The Problem</h2>
<p>Every leaf switch has two equal-cost paths to every other leaf switch. For example L1 uses S1 and S2 to reach the loopback interface of L2:</p>
<p class="code-caption">Routes toward the loopback interface of L2 on L1 running FRRouting<br /></p>
<pre><code>$ netlab connect -q l1 --show ip route 10.0.0.4
Routing entry for 10.0.0.4/32
  Known via &quot;isis&quot;, distance 115, metric 30, best
  Last update 00:01:17 ago
  * 10.1.0.2, via eth1, weight 1
  * 10.1.0.6, via eth2, weight 1
</code></pre>
<p>If you shut down S1, the routes using S1 (next hop 10.1.0.2) remain in the routing (and forwarding) table of L1 until L1 discovers it lost the link toward S1. That might be pretty fast if you can rely on the physical link-loss signal or take seconds if your only failure detection mechanism is the IS-IS hello protocol. Regardless of the failure detection time, there will be some traffic disruption.</p>
<h2 id="draining-traffic-from-an-is-is-router">Draining Traffic from an IS-IS Router</h2>
<p>We&rsquo;re using the <em>maximum metric</em> functionality in OSPF networks to solve a similar problem; if an OSPF router advertises all its links with a high metric, all other routers eventually find a better path, and the router is no longer used for transit traffic.</p>
<p>While some IS-IS implementations have a similar configuration command (for example, <code>advertise-high-metrics</code> on FRRouting), the IS-IS designers decided to take an even better approach years before OSPF got the <em>maximum metric</em> functionality: the IS-IS LSPs contain an <strong>overload</strong> bit that a router can use to tell everyone else to avoid it for transit traffic.</p>
<p>Setting the <strong>overload</strong> bit on S1 enables a clean shutdown. As the other routers receive and flood S1 LSP across the network, they recompute their best paths and remove routes using S1 (or replace them with alternate paths).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Abruptly increasing interface metrics or setting the <strong>overload</strong> bit could cause transient micro-loops in complex networks due to the asynchronous nature of IS-IS path computation. Fortunately, we won&rsquo;t experience micro-loops in our fabric, as we always have multiple equal-cost paths between the leaf switches.</p>
<p>At least one academic team published a paper describing an algorithm for computing a series of gradual metric increases that avoids micro-loops. However, I don&rsquo;t know anyone using that approach in a production network.</p>
</div>
<h2 id="configuration-tasks">Configuration Tasks</h2>
<p>Configure the <strong>overload</strong> bit in the IS-IS process of S1.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You&rsquo;re running a dual-stack network; some devices (for example, FRRouting) can set the <strong>overload</strong> bit for individual address families. Check what your devices are doing, or you might drain IPv4 traffic but leave IPv6 intact.</p>
</div>
<p>Check also the <em>IS-IS high metric</em> functionality on devices that support it as an alternative to the <strong>overload</strong> bit and in combination with it, and explore the resulting changes in the S1&rsquo;s IS-IS LSP, IS-IS topology, and IP routing table.</p>
<h2 id="validation">Validation</h2>
<p>You can use the <strong>netlab validate</strong> command if you&rsquo;re using <em>netlab</em> release 1.8.4 or later and run FRRouting on L1 and L2. This is the printout you&rsquo;d get if you failed to configure the <strong>overload</strong> bit:</p>
<p><img alt="" src="../validate-drain.png" /></p>
<p>You could also do manual validation of the routing tables on L1 and L2:</p>
<ul>
<li>There should be a single path (through S2) for the other leaf router&rsquo;s IPv4 and IPv6 loopback prefixes.</li>
<li>The IPv4 and IPv6 loopback prefixes of S1 should still be reachable (because it&rsquo;s not a transit route through S1).</li>
</ul>
<p class="code-caption">The final IPv4 loopback IS-IS routes on L1 (FRRouting)<br /></p>
<pre><code>l1# show ip route 10.0.0.0/24 longer-prefixes isis
Codes: K - kernel route, C - connected, L - local, S - static,
       R - RIP, O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
       f - OpenFabric, t - Table-Direct,
       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup
       t - trapped, o - offload failure

I&gt;* 10.0.0.1/32 [115/20] via 10.1.0.2, eth1, weight 1, 00:22:00
I&gt;* 10.0.0.2/32 [115/20] via 10.1.0.6, eth2, weight 1, 00:22:00
I&gt;* 10.0.0.4/32 [115/30] via 10.1.0.6, eth2, weight 1, 00:00:59
</code></pre>
<p>You can also inspect the S1 LSP to verify it has the <strong>overload</strong> bit set:</p>
<p class="code-caption">The S1 LSP on L1 (FRRouting). The overload bit is the summary line&rsquo;s <strong>/OL</strong> part.<br /></p>
<pre><code>l1# show isis database detail s1.00-00
Area Gandalf:
IS-IS Level-2 link-state database:
LSP ID                  PduLen  SeqNumber   Chksum  Holdtime  ATT/P/OL
s1.00-00                  112   0x00000004  0x0266    1618    0/0/1
  Protocols Supported: IPv4
  Area Address: 49.0001
  Hostname: s1
  TE Router ID: 10.0.0.1
  Router Capability: 10.0.0.1 , D:0, S:0
  Extended Reachability: 0000.0000.0003.00 (Metric: 10)
  Extended Reachability: 0000.0000.0004.00 (Metric: 10)
  IPv4 Interface Address: 10.0.0.1
  Extended IP Reachability: 10.1.0.0/30 (Metric: 10)
  Extended IP Reachability: 10.1.0.8/30 (Metric: 10)
  Extended IP Reachability: 10.0.0.1/32 (Metric: 10)
</code></pre>
<h2 id="other-uses-of-the-overload-bit">Other Uses of the Overload Bit</h2>
<p>Most IS-IS implementations can set the <strong>overload</strong> bit during the device startup process to prevent other routers from using a device for transit routing until it completes collecting routing information or initializing other control-plane protocols (for example, LDP).</p>
<p>Some implementations allow you to set the overload bit for a fixed amount of time; others are more flexible and can wait for the initial BGP convergence to complete before clearing the <strong>overload</strong> bit.</p>
<p>Finally, some implementors returned to the fundamentals and started using the <strong>overload</strong> bit for what it was initially designed to do: signal to the rest of the network that the router has performance problems (for example, running out of RAM due to a memory leak) and should be avoided.</p>
<h2 id="reference-information">Reference Information</h2>
<h3 id="lab-wiring">Lab Wiring</h3>
<table>
<thead>
<tr>
<th>Origin Device</th>
<th>Origin Port</th>
<th>Destination Device</th>
<th>Destination Port</th>
</tr>
</thead>
<tbody>
<tr>
<td>l1</td>
<td>eth1</td>
<td>s1</td>
<td>eth1</td>
</tr>
<tr>
<td>l1</td>
<td>eth2</td>
<td>s2</td>
<td>eth1</td>
</tr>
<tr>
<td>l2</td>
<td>eth1</td>
<td>s1</td>
<td>eth2</td>
</tr>
<tr>
<td>l2</td>
<td>eth2</td>
<td>s2</td>
<td>eth2</td>
</tr>
</tbody>
</table>
<p><strong>Note:</strong> The interface names depend on the devices you use in the lab. The printout was generated with lab devices running FRRouting.</p>
<h3 id="lab-addressing">Lab Addressing</h3>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th style="text-align: right;">IPv6 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>l1</strong></td>
<td style="text-align: right;">10.0.0.3/32</td>
<td style="text-align: right;">2001:db8:cafe:3::1/64</td>
<td>Loopback</td>
</tr>
<tr>
<td>eth1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td style="text-align: right;">LLA</td>
<td>l1 -&gt; s1</td>
</tr>
<tr>
<td>eth2</td>
<td style="text-align: right;">10.1.0.5/30</td>
<td style="text-align: right;">LLA</td>
<td>l1 -&gt; s2</td>
</tr>
<tr>
<td><strong>l2</strong></td>
<td style="text-align: right;">10.0.0.4/32</td>
<td style="text-align: right;">2001:db8:cafe:4::1/64</td>
<td>Loopback</td>
</tr>
<tr>
<td>eth1</td>
<td style="text-align: right;">10.1.0.9/30</td>
<td style="text-align: right;">LLA</td>
<td>l2 -&gt; s1</td>
</tr>
<tr>
<td>eth2</td>
<td style="text-align: right;">10.1.0.13/30</td>
<td style="text-align: right;">LLA</td>
<td>l2 -&gt; s2</td>
</tr>
<tr>
<td><strong>s1</strong></td>
<td style="text-align: right;">10.0.0.1/32</td>
<td style="text-align: right;">2001:db8:cafe:1::1/64</td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td style="text-align: right;">LLA</td>
<td>s1 -&gt; l1</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;">10.1.0.10/30</td>
<td style="text-align: right;">LLA</td>
<td>s1 -&gt; l2</td>
</tr>
<tr>
<td><strong>s2</strong></td>
<td style="text-align: right;">10.0.0.2/32</td>
<td style="text-align: right;">2001:db8:cafe:2::1/64</td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.6/30</td>
<td style="text-align: right;">LLA</td>
<td>s2 -&gt; l1</td>
</tr>
<tr>
<td>Ethernet2</td>
<td style="text-align: right;">10.1.0.14/30</td>
<td style="text-align: right;">LLA</td>
<td>s2 -&gt; l2</td>
</tr>
</tbody>
</table></div>
            </div>
        </div>

        <footer class="col-md-12">
<hr>
    <p>(C) 2023–2024 Ivan Pepelnjak (ipSpace.net AG)</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
